<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สถิติและผลดำเนินการคดีอาชญากรรมทางเทคโนโลยี</title>
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.10/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dropdown-content { max-height: 400px; overflow-y: auto; z-index: 999; }
        .tab-active { border-bottom: 3px solid #4f46e5; color: #4f46e5; }
        .ai-glow { box-shadow: 0 0 15px rgba(99, 102, 241, 0.4); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        const apiKey = ""; // API Key provided at runtime

        const Icon = ({ name, size = 20, className = "" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (window.lucide && containerRef.current) {
                    window.lucide.createIcons({
                        attrs: { class: className, width: size, height: size }
                    });
                }
            }, [name, size, className]);
            return <span ref={containerRef} className="inline-flex items-center justify-center"><i data-lucide={name}></i></span>;
        };

        const THAI_MONTHS = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];

        const CRIME_MAPPING = {
            "คดีหลอกลวงซื้อขายบริการ": "1.คดีซื้อสินค้าแต่ไม่ได้สินค้า (ไม่มีลักษณะเป็นขบวนการ)",
            "คดีหลอกลวงซื้อขายสินค้า": "1.คดีซื้อสินค้าแต่ไม่ได้สินค้า (ไม่มีลักษณะเป็นขบวนการ)",
            "หลอกลวงซื้อขายสินค้าหรือบริการ ที่ไม่มีลักษณะเป็นขบวนการ": "1.คดีซื้อสินค้าแต่ไม่ได้สินค้า (ไม่มีลักษณะเป็นขบวนการ)",
            "คดีซื้อสินค้าแต่ไม่ได้สินค้า (ไม่มีลักษณะเป็นขบวนการ)": "1.คดีซื้อสินค้าแต่ไม่ได้สินค้า (ไม่มีลักษณะเป็นขบวนการ)",
            "หลอกลวงเป็นบุคคลอื่นเพื่อยืมเงิน": "2.หลอกลวงเป็นบุคคลอื่นเพื่อยืมเงิน",
            "คดีปลอมโปรไฟล์เพื่อหลอกยืมเงิน": "2.หลอกลวงเป็นบุคคลอื่นเพื่อยืมเงิน",
            "คดีหลอกให้รักแล้วโอนเงิน (Romance Scam)": "3.หลอกลวงให้รักแล้วโอนเงิน (Romance Scam)",
            "คดีหลอกลวงให้โอนเงินเพื่อรับรางวัลหรือวัตถุประสงค์อื่นๆ": "4.หลอกลวงให้โอนเงินเพื่อรับรางวัลหรือวัตถุประสงค์อื่นๆ",
            "คดีหลอกให้กู้เงินแต่ไม่ได้เงิน": "5.คดีหลอกให้กู้เงิน",
            "หลอกลวงให้โอนเงินเพื่อทำงานหารายได้พิเศษ": "6.หลอกลวงให้โอนเงินเพื่อทำงานหารายได้พิเศษ",
            "คดีหลอกลวงทางโทรศัพท์ที่เป็นขบวนการ (Call Center)": "7.ข่มขู่ทางโทรศัพท์ให้เกิดความกลัวแล้วหลอกให้โอนเงิน"
        };

        const App = () => {
            const [mainData, setMainData] = useState([]);
            const [recoveryMap, setRecoveryMap] = useState({});
            const [arrestCountsMap, setArrestCountsMap] = useState({});
            const [attachmentMap, setAttachmentMap] = useState({});
            const [selectedTypes, setSelectedTypes] = useState([]);
            const [selectedStatuses, setSelectedStatuses] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [loadStatus, setLoadStatus] = useState('');
            const [aiSummary, setAiSummary] = useState('');
            const [isAiLoading, setIsAiLoading] = useState(false);

            const currentThaiYear = new Date().getFullYear() + 543;
            const [startMonth, setStartMonth] = useState(0);
            const [startYear, setStartYear] = useState(currentThaiYear);
            const [endMonth, setEndMonth] = useState(11);
            const [endYear, setEndYear] = useState(currentThaiYear);

            const [showTypeDropdown, setShowTypeDropdown] = useState(false);
            const [showStatusDropdown, setShowStatusDropdown] = useState(false);
            const dropdownRef = useRef(null);
            const statusDropdownRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) setShowTypeDropdown(false);
                    if (statusDropdownRef.current && !statusDropdownRef.current.contains(event.target)) setShowStatusDropdown(false);
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            const parseThaiDate = (dateStr) => {
                if (!dateStr || typeof dateStr !== 'string') return null;
                const parts = dateStr.split('/');
                if (parts.length < 3) return null;
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1;
                let yearPart = parts[2].split(' ')[0];
                let year = parseInt(yearPart);
                const originalYear = year;
                if (year > 2400) year -= 543;
                return { date: new Date(year, month, day), thaiYear: originalYear > 2400 ? originalYear : originalYear + 543, month: month };
            };

            const splitCSVLine = (line, delimiter) => {
                const values = [];
                let current = "";
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"' && line[i+1] === '"') { current += '"'; i++; }
                    else if (char === '"') inQuotes = !inQuotes;
                    else if (char === delimiter && !inQuotes) { values.push(current); current = ""; }
                    else current += char;
                }
                values.push(current);
                return values;
            };

            const availableYears = useMemo(() => {
                const years = [...new Set(mainData.map(d => d.thaiYear))].filter(y => y > 0).sort();
                return years.length === 0 ? [currentThaiYear] : years;
            }, [mainData, currentThaiYear]);

            const uniqueCategories = useMemo(() => [...new Set(mainData.map(item => item.type).filter(Boolean))].sort(), [mainData]);
            const uniqueStatuses = useMemo(() => [...new Set(mainData.map(item => item.status).filter(Boolean))].sort(), [mainData]);

            const finalData = useMemo(() => {
                return mainData.filter(item => {
                    const matchesType = selectedTypes.length === 0 || selectedTypes.includes(item.type);
                    const matchesStatus = selectedStatuses.length === 0 || selectedStatuses.includes(item.status);
                    const matchesSearch = searchTerm === '' || Object.values(item).some(val => String(val).toLowerCase().includes(searchTerm.toLowerCase()));
                    if (!item.parsedDate) return false;
                    const itemValue = item.thaiYear * 12 + item.monthNum;
                    const startValue = parseInt(startYear) * 12 + parseInt(startMonth);
                    const endValue = parseInt(endYear) * 12 + parseInt(endMonth);
                    return matchesType && matchesStatus && matchesSearch && itemValue >= startValue && itemValue <= endValue;
                }).map(item => {
                    const recoveryInfo = recoveryMap[item.caseId];
                    const arrestInfo = arrestCountsMap[item.caseId] || { warrants: 0, arrests: 0 };
                    const attach = attachmentMap[item.caseId];
                    return { 
                        ...item, 
                        isRecovered: !!recoveryInfo, 
                        recoveredAmount: recoveryInfo?.recoveredAmount || 0,
                        warrantCount: arrestInfo.warrants, 
                        arrestedCount: arrestInfo.arrests,
                        statementAttached: attach?.statementAttached || false, 
                        propertyAttached: attach?.propertyAttached || false
                    };
                });
            }, [mainData, recoveryMap, arrestCountsMap, attachmentMap, selectedTypes, selectedStatuses, searchTerm, startMonth, startYear, endMonth, endYear]);

            // --- Corrected Stats Calculation ---
            const stats = useMemo(() => {
                let totalRecoveredMoney = 0;
                let totalDamageMoney = 0;
                
                finalData.forEach(item => {
                    totalDamageMoney += (item.damageValue || 0);
                    if (item.isRecovered) {
                        totalRecoveredMoney += (item.recoveredAmount || 0);
                    }
                });

                const awaitingInterview = finalData.filter(item => item.status?.includes('นัดหมาย')).length;
                const awaitingBank = finalData.filter(item => item.status?.includes('ธนาคาร') || item.status?.includes('หมายเรียก') || item.status?.includes('พนักงานสอบสวน') || item.status?.includes('ดำเนินการ')).length;
                const pros = finalData.filter(item => item.status?.includes('ส่งสำนวนอัยการ') || item.status === 'ส่งพนักงานอัยการ').length;
                const closed = finalData.filter(item => item.status?.includes('สิ้นสุด')).length;
                const totalWarrants = finalData.reduce((sum, item) => sum + item.warrantCount, 0);
                const totalArrested = finalData.reduce((sum, item) => sum + item.arrestedCount, 0);
                const recoveredCount = finalData.filter(item => item.isRecovered).length;

                const operationalStats = [
                    { id: 'total', name: 'คดีรับแจ้งรวม', value: finalData.length, color: '#64748b', icon: 'file-text', desc: '(ทั้งหมดในช่วงเวลา)' },
                    { id: 'interview', name: 'รอสอบสวนปากคำ', value: awaitingInterview, color: '#f59e0b', icon: 'user-check', desc: '(สถานะ: นัดหมายผู้แจ้ง)' },
                    { id: 'processing', name: 'รอผลธนาคาร/ออกหมาย', value: awaitingBank, color: '#3b82f6', icon: 'clock', desc: '(อยู่ระหว่างดำเนินการ)' },
                    { id: 'prosecuted', name: 'ส่งสำนวนอัยการ', value: pros, color: '#8b5cf6', icon: 'briefcase', desc: '(ส่งพนักงานอัยการ)' },
                    { id: 'completed', name: 'คดีสิ้นสุด', value: closed, color: '#10b981', icon: 'check-circle', desc: '(สถานะ: สิ้นสุด)' },
                    { id: 'warrants', name: 'หมายจับสะสม', value: totalWarrants, color: '#ef4444', icon: 'scroll-text', desc: '(คลิกดู CASE ที่มีหมาย)' },
                    { id: 'arrests', name: 'จับกุมได้แล้ว', value: totalArrested, color: '#312e81', icon: 'handcuffs', desc: '(คลิกดู CASE ที่จับได้)' },
                    { id: 'recovered', name: 'ได้รับเงินคืน', value: recoveredCount, color: '#ec4899', icon: 'hand-coins', desc: '(จำนวนผู้เสียหายที่ได้เงินคืน)' }
                ];

                return { operationalStats, totalRecoveredMoney, totalDamageMoney };
            }, [finalData]);

            // --- Updated Gemini AI Analysis ---
            const callAiAnalysis = async () => {
                if (finalData.length === 0) return;
                setIsAiLoading(true);
                setAiSummary('');

                const aggregateData = {
                    totalCases: finalData.length,
                    totalRecovered: stats.totalRecoveredMoney, // Corrected Mapping
                    totalDamage: stats.totalDamageMoney,     // Actual Damage
                    types: {}
                };

                finalData.forEach(i => {
                    aggregateData.types[i.type] = (aggregateData.types[i.type] || 0) + 1;
                });

                const prompt = `
                    ช่วยวิเคราะห์สถิติอาชญากรรมทางเทคโนโลยีจากข้อมูลดังนี้:
                    - จำนวนคดีทั้งหมด: ${aggregateData.totalCases} เคส
                    - **ยอดมูลค่าความเสียหายที่ผู้เสียหายถูกหลอก (Total Damage):** ${aggregateData.totalDamage.toLocaleString()} บาท
                    - **ยอดเงินที่เจ้าหน้าที่ติดตามคืนให้ผู้เสียหายได้สำเร็จ (Total Recovered):** ${aggregateData.totalRecovered.toLocaleString()} บาท
                    - จำนวนผู้เสียหายที่ได้รับเงินคืน: ${stats.operationalStats.find(s => s.id === 'recovered').value} ราย
                    - อัตราการจับกุม (หมายจับ vs จับกุม): ${stats.operationalStats.find(s => s.id === 'warrants').value} vs ${stats.operationalStats.find(s => s.id === 'arrests').value}
                    
                    จำแนกตามประเภทคดี: ${JSON.stringify(aggregateData.types)}
                    
                    โปรดวิเคราะห์ประสิทธิภาพในการ "ติดตามเงินคืน" และ "อัตราการจับกุม" พร้อมสรุปแนวโน้มและข้อเสนอแนะเชิงนโยบาย (ภาษาทางการแต่เข้าใจง่าย)
                `;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    setAiSummary(data.candidates?.[0]?.content?.parts?.[0]?.text || "AI ไม่สามารถวิเคราะห์ได้ในขณะนี้");
                } catch (err) {
                    setAiSummary("เกิดข้อผิดพลาดในการวิเคราะห์ข้อมูล");
                } finally { setIsAiLoading(false); }
            };

            // --- Handlers ---
            const handleMainFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        let text = e.target.result.replace(/^\uFEFF/, '');
                        const rows = text.split(/\r?\n/).filter(r => r.trim() !== "");
                        if (rows.length < 2) return;
                        const delimiter = rows[0].split(';').length > rows[0].split(',').length ? ';' : ',';
                        const headers = rows[0].split(delimiter).map(h => h.trim().replace(/"/g, ''));
                        const parsed = rows.slice(1).map((row) => {
                            const values = splitCSVLine(row, delimiter);
                            const entry = {};
                            headers.forEach((header, index) => { if (header) entry[header] = values[index]?.trim().replace(/"/g, ''); });
                            const findVal = (keys) => {
                                const foundKey = Object.keys(entry).find(k => keys.some(target => k.includes(target)));
                                return foundKey ? entry[foundKey] : null;
                            };
                            entry.damageValue = parseFloat(findVal(['มูลค่าความเสียหาย', 'damage'])?.replace(/,/g, '')) || 0;
                            const dateRaw = findVal(['วันที่รับแจ้ง', 'date']);
                            const dateObj = parseThaiDate(dateRaw);
                            entry.parsedDate = dateObj?.date; entry.thaiYear = dateObj?.thaiYear; entry.monthNum = dateObj?.month;
                            entry.caseId = findVal(['เลขรับแจ้ง', 'id', 'เคสไอดี']);
                            entry.officer = findVal(['พนักงานสอบสวน', 'officer']);
                            const rawType = findVal(['ประเภทคดี', 'type'])?.trim();
                            if (CRIME_MAPPING[rawType]) { entry.type = CRIME_MAPPING[rawType]; } 
                            else { entry.type = rawType || "ไม่ระบุ"; }
                            entry.victim = findVal(['ผู้เสียหาย', 'victim']); entry.status = findVal(['สถานะ', 'status']);
                            entry.dateStr = dateRaw;
                            return entry;
                        }).filter(item => item.caseId);
                        setMainData(parsed);
                    } catch (err) { setLoadStatus('เกิดข้อผิดพลาดในการโหลดไฟล์หลัก'); }
                };
                reader.readAsText(file);
            };

            const handleRecoveryFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        let text = e.target.result.replace(/^\uFEFF/, '');
                        const rows = text.split(/\r?\n/).filter(r => r.trim() !== "");
                        const delimiter = rows[0].split(';').length > rows[0].split(',').length ? ';' : ',';
                        const headers = rows[0].split(delimiter).map(h => h.trim().replace(/"/g, ''));
                        const caseIdx = headers.findIndex(h => h.includes('เลขรับแจ้ง') || h.includes('เคสไอดี') || h.toUpperCase().includes('CASE ID'));
                        const moneyIdx = headers.findIndex(h => h.includes('เงิน') || h.includes('ยอด'));
                        const map = {};
                        rows.slice(1).forEach(row => {
                            const values = splitCSVLine(row, delimiter);
                            const caseId = values[caseIdx]?.trim();
                            if (caseId) map[caseId] = { recovered: true, recoveredAmount: parseFloat(String(values[moneyIdx])?.replace(/,/g, '')) || 0 };
                        });
                        setRecoveryMap(map); setLoadStatus(`นำเข้าข้อมูลเงินคืนสำเร็จ`);
                    } catch (err) { setLoadStatus('นำเข้าเงินคืนไม่สำเร็จ'); }
                };
                reader.readAsText(file);
            };

            const handleArrestFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        let text = e.target.result.replace(/^\uFEFF/, '');
                        const rows = text.split(/\r?\n/).filter(r => r.trim() !== "");
                        const delimiter = rows[0].split(';').length > rows[0].split(',').length ? ';' : ',';
                        const headers = rows[0].split(delimiter).map(h => h.trim().replace(/"/g, ''));
                        const caseIdIdx = headers.findIndex(h => h.includes('เคสไอดี') || h.toUpperCase().includes('CASE ID'));
                        const arrestStatusIdx = headers.findIndex(h => h.includes('สถานะการจับกุม'));
                        const counts = {}; 
                        rows.slice(1).forEach(row => {
                            const values = splitCSVLine(row, delimiter);
                            const caseId = values[caseIdIdx]?.trim();
                            if (caseId) {
                                if (!counts[caseId]) counts[caseId] = { warrants: 0, arrests: 0 };
                                counts[caseId].warrants += 1;
                                if (values[arrestStatusIdx]?.trim() !== "") counts[caseId].arrests += 1;
                            }
                        });
                        setArrestCountsMap(counts); setLoadStatus(`อัปเดตข้อมูลหมายจับสำเร็จ`);
                    } catch (err) { setLoadStatus('นำเข้าไฟล์หมายจับไม่สำเร็จ'); }
                };
                reader.readAsText(file);
            };

            const handleAttachmentFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        let text = e.target.result.replace(/^\uFEFF/, '');
                        const rows = text.split(/\r?\n/).filter(r => r.trim() !== "");
                        const delimiter = rows[0].split(';').length > rows[0].split(',').length ? ';' : ',';
                        const headers = rows[0].split(delimiter).map(h => h.trim().replace(/"/g, ''));
                        const caseIdx = headers.findIndex(h => h.includes('เคสไอดี') || h.includes('เลขรับแจ้ง'));
                        const statementIdx = headers.findIndex(h => h.includes('คำให้การ'));
                        const propertyIdx = headers.findIndex(h => h.includes('บัญชีทรัพย์'));
                        const map = {};
                        rows.slice(1).forEach(row => {
                            const values = splitCSVLine(row, delimiter);
                            const caseId = values[caseIdx]?.trim();
                            if (caseId) {
                                map[caseId] = {
                                    statementAttached: values[statementIdx]?.trim() === "แนบแล้ว",
                                    propertyAttached: values[propertyIdx]?.trim() === "แนบแล้ว"
                                };
                            }
                        });
                        setAttachmentMap(map); setLoadStatus(`นำเข้าข้อมูลไฟล์แนบสำเร็จ`);
                    } catch (err) { setLoadStatus('นำเข้าไฟล์แนบไม่สำเร็จ'); }
                };
                reader.readAsText(file);
            };

            return (
                <div className="p-4 md:p-8 max-w-[1600px] mx-auto min-h-screen">
                    {/* Header */}
                    <header className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6 bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
                        <div>
                            <h1 className="text-2xl md:text-3xl font-extrabold text-slate-900 flex items-center gap-3"><Icon name="shield" size={28} className="text-indigo-600" />สถิติและผลดำเนินการคดีอาชญากรรมทางเทคโนโลยี</h1>
                            <p className="text-slate-500 mt-2 font-medium text-sm"><Icon name="info" size={14} className={loadStatus.includes('สำเร็จ') ? "text-emerald-600 font-bold" : "text-slate-400"} /><span>{loadStatus || 'กรุณาอัปโหลดไฟล์สถิติหลักเพื่อเริ่มใช้งาน'}</span></p>
                        </div>
                        <div className="flex flex-wrap gap-2">
                            <label className="flex items-center gap-2 bg-slate-900 hover:bg-slate-800 text-white px-4 py-2.5 rounded-xl transition-all cursor-pointer shadow-md font-bold text-xs"><Icon name="upload" size={16} /> สถิติหลัก<input type="file" accept=".csv" onChange={handleMainFileUpload} className="hidden" /></label>
                            <label className="flex items-center gap-2 bg-pink-600 hover:bg-pink-700 text-white px-4 py-2.5 rounded-xl transition-all cursor-pointer shadow-md font-bold text-xs"><Icon name="hand-coins" size={16} /> ข้อมูลเงินคืน<input type="file" accept=".csv" onChange={handleRecoveryFileUpload} className="hidden" /></label>
                            <label className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2.5 rounded-xl transition-all cursor-pointer shadow-md font-bold text-xs"><Icon name="gavel" size={16} /> หมายจับ<input type="file" accept=".csv" onChange={handleArrestFileUpload} className="hidden" /></label>
                            <label className="flex items-center gap-2 bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-2.5 rounded-xl transition-all cursor-pointer shadow-md font-bold text-xs"><Icon name="file-plus" size={16} /> แนบไฟล์เจ้าหน้าที่<input type="file" accept=".csv" onChange={handleAttachmentFileUpload} className="hidden" /></label>
                        </div>
                    </header>

                    {/* Filter Section */}
                    <section className="mb-8 bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100 flex flex-col gap-6">
                        <div className="w-full">
                            <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">ช่วงวันที่รับแจ้ง</label>
                            <div className="flex flex-wrap gap-2 items-center bg-slate-50 p-3 rounded-2xl border border-slate-100 w-full lg:w-fit">
                                <select className="bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm font-bold outline-none" value={startMonth} onChange={e => setStartMonth(e.target.value)}>{THAI_MONTHS.map((m, i) => <option key={i} value={i}>{m}</option>)}</select>
                                <select className="bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm font-bold outline-none w-28" value={startYear} onChange={e => setStartYear(e.target.value)}>{availableYears.map(y => <option key={y} value={y}>{y}</option>)}</select>
                                <span className="font-black text-slate-300 px-3 uppercase text-xs">ถึง</span>
                                <select className="bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm font-bold outline-none" value={endMonth} onChange={e => setEndMonth(e.target.value)}>{THAI_MONTHS.map((m, i) => <option key={i} value={i}>{m}</option>)}</select>
                                <select className="bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm font-bold outline-none w-28" value={endYear} onChange={e => setEndYear(e.target.value)}>{availableYears.map(y => <option key={y} value={y}>{y}</option>)}</select>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-12 gap-4 items-end">
                            <div className="lg:col-span-3 filter-item" ref={dropdownRef}>
                                <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">กรองประเภทคดี</label>
                                <button onClick={() => setShowTypeDropdown(!showTypeDropdown)} className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs font-bold text-left flex justify-between items-center h-10 hover:bg-slate-100"><span className="truncate">{selectedTypes.length === 0 ? 'ทุกประเภทคดี' : `เลือกแล้ว ${selectedTypes.length}`}</span><Icon name="chevron-down" size={12} /></button>
                                {showTypeDropdown && (<div className="absolute mt-2 bg-white border border-slate-200 rounded-2xl shadow-2xl dropdown-content p-2"><div className="flex justify-between p-2 border-b mb-2"><button onClick={() => setSelectedTypes([])} className="text-[9px] font-black text-blue-600">ล้าง</button><button onClick={() => setSelectedTypes(uniqueCategories)} className="text-[9px] font-black text-blue-600">ทั้งหมด</button></div>{uniqueCategories.map(cat => (<label key={cat} className="flex items-center gap-2 p-2 hover:bg-slate-50 rounded-lg cursor-pointer"><input type="checkbox" className="rounded border-slate-300 text-indigo-600" checked={selectedTypes.includes(cat)} onChange={() => setSelectedTypes(prev => prev.includes(cat) ? prev.filter(t => t !== cat) : [...prev, cat])} /><span className="text-[10px] font-bold text-slate-700">{cat}</span></label>))}</div>)}
                            </div>
                            <div className="lg:col-span-3 filter-item"><label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">ค้นหา</label><div className="relative"><Icon name="search" size={14} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" /><input type="text" placeholder="CASE ID..." className="w-full bg-slate-50 border border-slate-200 rounded-lg pl-9 pr-3 py-2 text-xs font-bold h-10 outline-none" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /></div></div>
                            <div className="lg:col-span-2 bg-slate-800 text-white p-2 rounded-2xl text-center shadow-lg h-14 flex flex-col justify-center transition-transform hover:scale-105 filter-item min-w-[110px]"><p className="text-[8px] font-bold uppercase tracking-widest opacity-80 mb-1 leading-none">เสียหายรวม</p><p className="text-[10px] font-black leading-none font-mono truncate">฿{stats.totalDamageMoney.toLocaleString()}</p></div>
                            <div className="lg:col-span-2 bg-pink-600 text-white p-2 rounded-2xl text-center shadow-lg h-14 flex flex-col justify-center transition-transform hover:scale-105 filter-item min-w-[110px]"><p className="text-[8px] font-bold uppercase tracking-widest opacity-80 mb-1 leading-none">ยอดเงินคืนรวม</p><p className="text-[10px] font-black leading-none font-mono truncate">฿{stats.totalRecoveredMoney.toLocaleString()}</p></div>
                        </div>
                    </section>

                    {/* AI Section */}
                    {finalData.length > 0 && (
                        <div className="mb-10 animate-in fade-in duration-500">
                            <div className="bg-gradient-to-br from-indigo-50 to-white p-6 rounded-[2rem] border border-indigo-100 shadow-sm ai-glow">
                                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                                    <div className="flex items-center gap-3"><div className="p-3 bg-indigo-600 text-white rounded-2xl shadow-lg"><Icon name="sparkles" size={24} /></div><div><h3 className="text-xl font-extrabold text-slate-800">AI วิเคราะห์เจาะลึกสถิติ ✨</h3><p className="text-sm text-slate-500 font-medium italic">ประมวลผลข้อมูลความเสียหายเทียบกับยอดเงินคืน</p></div></div>
                                    <button onClick={callAiAnalysis} disabled={isAiLoading} className={`flex items-center gap-2 px-6 py-3 rounded-2xl font-bold shadow-md transition-all ${isAiLoading ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-indigo-600 text-white hover:bg-indigo-700 active:scale-95'}`}>
                                        {isAiLoading ? <div className="animate-spin h-5 w-5 border-2 border-slate-300 border-t-indigo-600 rounded-full"></div> : <Icon name="wand-2" size={18} />} {isAiLoading ? 'กำลังวิเคราะห์...' : '✨ วิเคราะห์ข้อมูลด้วย AI'}
                                    </button>
                                </div>
                                {aiSummary && (<div className="bg-white/60 backdrop-blur-md p-6 rounded-3xl border border-white/80 text-slate-700 leading-relaxed shadow-inner max-h-[400px] overflow-y-auto whitespace-pre-line text-sm font-medium">{aiSummary}</div>)}
                            </div>
                        </div>
                    )}

                    {/* Operational Stats */}
                    <section className="mb-10 text-center">
                        <div className="flex items-center gap-2 mb-6 border-l-4 border-indigo-600 pl-4"><h2 className="text-xl font-black text-slate-800 uppercase tracking-tight">สรุปผลการปฏิบัติงาน</h2></div>
                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-4 gap-4 mb-4 text-center">
                            {stats.operationalStats.map((op, idx) => (
                                <div key={idx} className="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm border-b-4 transition-all hover:scale-[1.02]" style={{ borderBottomColor: op.color }}>
                                    <div className="flex justify-between items-start mb-4"><div className="p-3 rounded-2xl" style={{ backgroundColor: `${op.color}15`, color: op.color }}><Icon name={op.icon} size={24} /></div><span className="text-3xl font-black" style={{ color: op.color }}>{op.value.toLocaleString()}</span></div>
                                    <p className="text-xs font-black text-slate-600 mb-1 leading-tight text-left">{op.name}</p><p className="text-[10px] text-slate-400 font-bold leading-tight text-left">{op.desc}</p>
                                </div>
                            ))}
                        </div>
                    </section>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
